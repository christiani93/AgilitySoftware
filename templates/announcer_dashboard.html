{% extends "layout.html" %}
{% block title %}Sprecher Dashboard: {{ event.Bezeichnung }}{% endblock %}

{% block content %}
<div class="container-fluid announcer-container">

    {# NEU: Container für den dynamisch geladenen Zeitplan #}
    <div id="schedule-container" class="row mb-4 no-print">
        <div class="col-12 text-center">
            <p>Lade Zeitplan...</p>
        </div>
    </div>

    <div id="dashboard-container" class="row">
        <div class="col-12 text-center p-5">
            <h2><i class="fas fa-spinner fa-spin me-2"></i>Lade Live-Daten...</h2>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dashboardContainer = document.getElementById('dashboard-container');
    const scheduleContainer = document.getElementById('schedule-container');
    const eventId = '{{ event.id }}';
    const socket = io();

    function fetchAndRenderRing(ringName) {
        fetch(`{{ url_for('live_bp.render_speaker_panel_content', event_id=event.id, ring_name='__RING_NAME__') }}`.replace('__RING_NAME__', ringName))
            .then(response => response.text())
            .then(html => {
                const colId = `ring-col-${ringName.replace(' ', '-')}`;
                let col = document.getElementById(colId);
                if (!col) {
                    col = document.createElement('div');
                    col.className = 'col-lg mb-4';
                    col.id = colId;
                    dashboardContainer.appendChild(col);
                }
                col.innerHTML = html;
            });
    }

    function fetchAndRenderSchedule() {
        fetch(`{{ url_for('live_bp.render_announcer_schedule', event_id=event.id) }}`)
            .then(response => response.text())
            .then(html => {
                scheduleContainer.innerHTML = html;
            });
    }
    
    function initialLoad() {
        // Leere den Platzhalter
        dashboardContainer.innerHTML = '';
        
        fetchAndRenderSchedule();
        
        // Ring-Spalten basierend auf Zeitplan laden
        fetch("{{ url_for('live_bp.render_announcer_schedule', event_id=event.id) }}")
            .then(res => res.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const ringDivs = tempDiv.querySelectorAll('.col-md-6');
                const numRings = ringDivs.length;
                if (numRings > 0) {
                    dashboardContainer.innerHTML = ''; // Clear loading spinner
                    ringDivs.forEach(div => {
                        const ringName = div.querySelector('h6').textContent.replace('Zeitplan ', '');
                        const col = document.createElement('div');
                        col.className = `col-lg-${12 / numRings} mb-4`;
                        col.id = `ring-col-${ringName.replace(' ', '-')}`;
                        dashboardContainer.appendChild(col);
                        fetchAndRenderRing(ringName);
                    });
                } else {
                     dashboardContainer.innerHTML = '<div class="col-12 alert alert-warning">Keine Ringe für dieses Event konfiguriert.</div>';
                }
            });
    }

    socket.on('connect', function() {
        console.log('Socket.IO connected!');
    });

    socket.on('announcer_update', function(data) {
        if (data.event_id === eventId) {
            console.log('Update received for ring:', data.ring_name);
            fetchAndRenderRing(data.ring_name);
            // NEU: Zeitplan ebenfalls aktualisieren
            fetchAndRenderSchedule();
        }
    });

    initialLoad();
});
</script>
{% endblock %}