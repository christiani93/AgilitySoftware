{% extends "layout.html" %}
{% block title %}Teilnehmer manuell erfassen{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h3>Teilnehmer manuell erfassen</h3>
                <p class="mb-0">
                    Der Teilnehmer wurde nicht gefunden. Bitte erfassen Sie die notwendigen Daten.
                </p>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('events_bp.add_manual_participant_save', event_id=event.id, run_id=(run.run_id or run.id)) }}">
                    
                    <h4>Angaben zum Hund</h4>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="license_number" class="form-label">Lizenznummer</label>
                            <input type="text" class="form-control" id="license_number" name="license_number" value="{{ license_nr or '' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dog_name" class="form-label">Name des Hundes</label>
                            <input type="text" class="form-control" id="dog_name" name="dog_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dog_breed" class="form-label">Rasse</label>
                            <input type="text" class="form-control" id="dog_breed" name="dog_breed">
                        </div>
                        <div class="col-md-6">
                            <label for="dog_category" class="form-label">Grössenkategorie</label>
                            <select id="dog_category" name="dog_category" class="form-select" required>
                                <option>Small</option><option>Medium</option><option>Intermediate</option><option>Large</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="dog_class" class="form-label">Globale Klasse</label>
                            <select id="dog_class" name="dog_class" class="form-select" required>
                                <option>1</option><option>2</option><option>3</option><option>Oldie</option>
                            </select>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h4>Angaben zum Hundeführer</h4>
                    <div class="mb-3">
                        <label for="handler_id" class="form-label">Hundeführer</label>
                        <select class="form-select" id="handler_id" name="handler_id">
                            <option value="">-- Neuen Hundeführer anlegen --</option>
                            {% for h in all_handlers|sort(attribute='lastname') %}
                            <option value="{{ h.id }}" data-club-nr="{{ h.club_nr or '' }}" {% if prefill.handler_firstname and h.firstname == prefill.handler_firstname and h.lastname == prefill.handler_lastname %}selected{% endif %}>{{ h.firstname }} {{ h.lastname }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="new-handler-fields">
                        <div class="row g-3">
                             <div class="col-md-6" id="new_handler_firstname_group">
                                <label for="handler_firstname" class="form-label">Vorname (neu)</label>
                                <input type="text" class="form-control" id="handler_firstname" name="handler_firstname" value="{{ prefill.handler_firstname or '' }}">
                            </div>
                            <div class="col-md-6" id="new_handler_lastname_group">
                                <label for="handler_lastname" class="form-label">Nachname (neu)</label>
                                <input type="text" class="form-control" id="handler_lastname" name="handler_lastname" value="{{ prefill.handler_lastname or '' }}">
                            </div>
                            <div class="col-md-12">
                                <label for="club_nr" class="form-label">Verein</label>
                                <select class="form-select" id="club_nr" name="club_nr">
                                    <option value="">Kein Verein</option>
                                    {% for club in clubs|sort(attribute='name') %}
                                    <option value="{{ club.nummer }}" {% if prefill.club_nr == club.nummer %}selected{% endif %}>{{ club.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Dieser Verein wird dem Hundeführer zugewiesen oder bei einem bestehenden Hundeführer aktualisiert.</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">

                    <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Teilnehmer erfassen und hinzufügen</button>
                    <a href="{{ url_for('events_bp.manage_run_participants', event_id=event.id) }}" class="btn btn-secondary btn-lg">Abbrechen</a>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const handlerSelect = document.getElementById('handler_id');
    const newHandlerFirstnameGroup = document.getElementById('new_handler_firstname_group');
    const newHandlerLastnameGroup = document.getElementById('new_handler_lastname_group');
    const fnameInput = document.getElementById('handler_firstname');
    const lnameInput = document.getElementById('handler_lastname');
    const clubSelect = document.getElementById('club_nr');

    function toggleNewHandlerFields() {
        if (handlerSelect.value === "") {
            newHandlerFirstnameGroup.style.display = 'block';
            newHandlerLastnameGroup.style.display = 'block';
            fnameInput.required = true;
            lnameInput.required = true;
        } else {
            newHandlerFirstnameGroup.style.display = 'none';
            newHandlerLastnameGroup.style.display = 'none';
            fnameInput.required = false;
            lnameInput.required = false;

            // Verein für den ausgewählten Hundeführer setzen
            const selectedOption = handlerSelect.options[handlerSelect.selectedIndex];
            const clubNr = selectedOption.getAttribute('data-club-nr');
            clubSelect.value = clubNr || "";
        }
    }

    handlerSelect.addEventListener('change', toggleNewHandlerFields);
    toggleNewHandlerFields();
});
</script>
{% endblock %}
