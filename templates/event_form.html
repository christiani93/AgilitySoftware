{% extends "layout.html" %}
{% block title %}{{ form_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ form_title }}</h2>
    <form method="POST">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="bezeichnung" class="form-label">Bezeichnung</label>
                        <input type="text" class="form-control" id="bezeichnung" name="bezeichnung" value="{{ event.get('Bezeichnung', '') }}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="datum" class="form-label">Datum</label>
                        <input type="date" class="form-control" id="datum" name="datum" value="{{ event.get('Datum', today) }}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="veranstalter_club_nr" class="form-label">Veranstalter</label>
                        <select class="form-select" id="veranstalter_club_nr" name="veranstalter_club_nr">
                            <option value="">--- Bitte auswählen ---</option>
                            {% for club in clubs %}
                                <option value="{{ club.nummer }}" {% if club.nummer == event.get('VeranstalterClubNr') %}selected{% endif %}>{{ club.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="turniernummer" class="form-label">Turniernummer</label>
                        <input type="text" class="form-control" id="turniernummer" name="turniernummer" value="{{ event.get('Turniernummer', '') }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="num_rings" class="form-label">Anzahl Ringe</label>
                        <input type="number" class="form-control" id="num_rings" name="num_rings" min="1" value="{{ event.get('num_rings', 1) }}">
                    </div>
                    <div class="col-md-9 mb-3">
                        <div id="start-times-container">
                            </div>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="veranstaltungsart" class="form-label">Veranstaltungsart</label>
                        <select class="form-select" id="veranstaltungsart" name="veranstaltungsart">
                            {% for type in event_types %}<option value="{{ type }}" {% if type == event.get('Veranstaltungsart') %}selected{% endif %}>{{ type }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                
                {% if not is_edit %}
                <hr>
                <h5>Läufe automatisch erstellen</h5>
                <div class="row">
                    <div class="col-md-4">
                        <p class="mb-1">Laufarten:</p>
                        {% for la in ["Agility", "Jumping", "Spiel"] %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="laufart_auto" value="{{ la }}" id="la_{{la}}" {% if la in ['Agility', 'Jumping'] %}checked{% endif %}>
                            <label class="form-check-label" for="la_{{la}}">{{ la }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1">Kategorien:</p>
                        {% for kat in possible_categories %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="kategorien_verfuegbar" value="{{ kat }}" id="kat_{{kat}}" checked>
                            <label class="form-check-label" for="kat_{{kat}}">{{ kat }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1">Klassen:</p>
                        {% for kl in possible_classes %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="klassen_verfuegbar" value="{{ kl }}" id="kl_{{kl}}" {% if kl != 'Oldie' %}checked{% endif %}>
                            <label class="form-check-label" for="kl_{{kl}}">{{ kl }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-primary">Speichern</button>
                <a href="{{ url_for('events_bp.events_list') }}" class="btn btn-secondary">Abbrechen</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const numRingsInput = document.getElementById('num_rings');
    const startTimesContainer = document.getElementById('start-times-container');
    const existingStartTimes = {{ event.get('start_times_by_ring', {}) | tojson | safe }};

    function updateStartTimes() {
        const numRings = parseInt(numRingsInput.value, 10) || 1;
        startTimesContainer.innerHTML = ''; 

        const row = document.createElement('div');
        row.className = 'row';

        for (let i = 1; i <= numRings; i++) {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-3';
            
            const label = document.createElement('label');
            label.htmlFor = `start_time_ring_${i}`;
            label.className = 'form-label';
            label.textContent = `Startzeit Ring ${i}`;

            const input = document.createElement('input');
            input.type = 'time';
            input.className = 'form-control';
            input.id = `start_time_ring_${i}`;
            input.name = `start_time_ring_${i}`;
            
            // Setzt den Wert aus bestehenden Daten oder auf den Standardwert 07:30
            input.value = existingStartTimes[`ring_${i}`] || '07:30';
            
            col.appendChild(label);
            col.appendChild(input);
            row.appendChild(col);
        }
        startTimesContainer.appendChild(row);
    }

    numRingsInput.addEventListener('change', updateStartTimes);
    
    // Initiale Generierung der Felder beim Laden der Seite
    updateStartTimes();
});
</script>
{% endblock %}