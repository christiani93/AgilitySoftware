{% extends "layout.html" %}
{% block title %}Live Dashboard: {{ event.Bezeichnung }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">Live Dashboard</h1>
        <p class="text-muted fs-5">{{ event.Bezeichnung }}</p>
    </div>
    <div>
        <a href="{{ url_for('events_bp.manage_runs', event_id=event.id) }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Zurück zur Verwaltung</a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5><i class="fas fa-desktop me-2"></i>Öffentliche Anzeigen & Teilen</h5>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2 mb-3">
            <a href="{{ url_for('live_bp.announcer_dashboard', event_id=event.id) }}" target="_blank" class="btn btn-dark"><i class="fas fa-users me-2"></i>Sprecher-Dashboard</a>
            {% for i in range(1, (event.num_rings or 1) + 1) %}
            <div class="btn-group">
                <a href="{{ url_for('live_bp.display_ring_monitor', ring_number=i) }}" target="_blank" class="btn btn-secondary"><i class="fas fa-tv me-2"></i>Ring {{ i }} Monitor</a>
                <a href="{{ url_for('live_bp.ring_pc_dashboard', ring_number=i) }}" target="_blank" class="btn btn-warning"><i class="fas fa-laptop-code me-2"></i>Ring-PC</a>
            </div>
            {% endfor %}
            <a href="{{ url_for('print_bp.select_award_list', event_id=event.id) }}" class="btn btn-success">
                <i class="fas fa-trophy me-1"></i> Rangverkündigungsliste erstellen
            </a>
        </div>
    </div>
</div>

<div class="row">
    {% for ring_name, runs_in_ring in runs_by_ring.items() %}
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-dark text-white"><h4 class="mb-0">{{ ring_name }}</h4></div>
            <div class="list-group list-group-flush">
                {% for run in runs_in_ring|sort(attribute='name') %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">{{ run.name }}</h5>
                        <small>
                            {% set completed = run.entries|selectattr('result')|list|length %}
                            <span class="badge rounded-pill bg-{{ 'success' if completed == run.entries|length and completed > 0 else 'secondary' }}">
                                {{ completed }} / {{ run.entries|length }}
                            </span>
                        </small>
                    </div>
                    <p class="mb-1">Richter: {% set judge = judges|selectattr('id', 'equalto', run.richter_id)|first %}{{ (judge.firstname ~ ' ' ~ judge.lastname).strip() if judge else 'N/A' }}</p>
                    <div class="btn-group mt-2">
                        <a href="{{ url_for('live_bp.live_run_entry', event_id=event.id, run_id=run.id) }}" class="btn btn-primary btn-sm"><i class="fas fa-keyboard me-2"></i>Resultate erfassen</a>
                        <a href="{{ url_for('print_bp.print_ranking_single', event_id=event.id, run_id=run.id) }}" target="_blank" class="btn btn-info btn-sm text-white"><i class="fas fa-trophy me-2"></i>Rangliste (Druck)</a>
                        <a href="{{ url_for('live_bp.set_active_announcer_run', event_id=event.id, run_id=run.id) }}" class="btn btn-warning btn-sm"><i class="fas fa-bullhorn me-2"></i>Für Sprecher</a>
                    </div>
                </div>
                {% else %}
                 <div class="list-group-item text-muted">Für diesen Ring sind keine Läufe im Zeitplan eingetragen.</div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-warning">Für diese Veranstaltung wurden keine Läufe einem Ring zugewiesen. Bitte erstellen Sie zuerst einen <a href="{{ url_for('events_bp.plan_schedule', event_id=event.id) }}">Zeitplan</a>.</div>
    </div>
    {% endfor %}
</div>
{% endblock %}