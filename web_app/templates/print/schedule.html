<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zeitplan - {{ event.Bezeichnung }}</title>
    <style>
        body { font-family: sans-serif; }
        :root { --print-header-height: 90px; }
        @page { size: A4; margin: 25mm 10mm 15mm 10mm; }

        .print-header { position: fixed; top: 0; left: 0; right: 0; height: var(--print-header-height); display: flex; align-items: center; justify-content: space-between; gap: 1rem; background: #fff; z-index: 10; }
        .print-header__logo { width: 2.5cm; display: flex; align-items: center; justify-content: center; }
        .print-header__logo-box { width: 2.2cm; height: 2.2cm; border: 1px solid #999; background: #f5f5f5; color: #666; font-size: 9pt; display: flex; align-items: center; justify-content: center; text-align: center; }
        .print-header__titles { text-align: center; flex: 1; font-size: 10pt; }
        .print-header__title { font-size: 1.1em; font-weight: 600; }
        .print-header__subtitle { font-size: 0.95em; color: #555; margin-bottom: 2px; }
        .print-header__meta { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; font-size: 9pt; color: #444; }

        main { margin-top: 0; }
        
        /* NEU: Jeder Ring auf einer neuen Seite (Punkt 2) */
        .ring-page { page-break-after: always; }
        .ring-page:last-child { page-break-after: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-top: 1cm; page-break-inside: auto;}
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        th { background-color: #f2f2f2; }
        thead { display: table-header-group; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        h3 { text-align: left; margin-top: 1.5cm; }

        @media print {
            body { margin: 0; }
            main { margin-top: 0 !important; padding-top: 0 !important; }
        }
    </style>
</head>
<body>
    {% set title = 'Zeitplan' %}
    {% include 'print/_print_header.html' %}

    <main>
        {% for ring, timeline in timelines_by_ring.items()|sort %}
        <div class="ring-page">
            <h3>Zeitplan Ring {{ ring }} (Start: {{ (event.start_times_by_ring or {}).get('ring_' + ring, 'N/A') }})</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">Start</th>
                        <th style="width: 15%;">Ende</th>
                        <th>Aktion</th>
                        {# NEU: Richter statt Dauer (Punkt 1) #}
                        <th style="width: 25%;">Richter</th>
                        <th style="width: 15%;">Starter</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in timeline %}
                    <tr>
                        <td>{{ item.start_time }}</td>
                        <td>{{ item.end_time }}</td>
                        <td>
                            <strong>{{ item.label }}</strong>
                            {% if item.block.type == 'run' %}
                              {% set run_type = (item.block.timing_run_type or '').lower() %}
                              {% set run_type_label = 'Agility' if run_type == 'agility' else 'Jumping' if run_type == 'jumping' else 'Other' %}
                              {% set run_prefix = 'Open ' if (item.block.run_format or '').lower() == 'open' else '' %}
                              {% set class_part = (item.block.classes or [])|join('+') %}
                              {% set primary = (item.block.sort or {}).get('primary', {}) %}
                              {% set direction = (primary.get('direction', 'asc') or 'asc') %}
                              {% set size_order = ['small','medium','intermediate','large'] %}
                              {% if direction == 'desc' %}
                                {% set size_order = ['large','intermediate','medium','small'] %}
                              {% endif %}
                              {% set selected_sizes = item.block.size_categories or [] %}
                              {% if not selected_sizes %}
                                {% if item.block.size_category and item.block.size_category != 'all' %}
                                  {% set selected_sizes = [item.block.size_category] %}
                                {% else %}
                                  {% set selected_sizes = size_order %}
                                {% endif %}
                              {% endif %}
                              {% set size_map = {'small':'S','medium':'M','intermediate':'I','large':'L'} %}
                              {% set ns = namespace(parts=[]) %}
                              {% for size in size_order %}
                                {% if size in selected_sizes %}
                                  {% set ns.parts = ns.parts + [size_map.get(size, size)] %}
                                {% endif %}
                              {% endfor %}
                              {% set short_label = ns.parts|join('/') %}
                              <div class="small text-muted">{{ run_prefix }}{{ run_type_label }}{% if class_part %} {{ class_part }}{% endif %}{% if short_label %} {{ short_label }}{% endif %}</div>
                            {% elif item.block.title %}
                              <div class="small text-muted">{{ item.block.title }}</div>
                            {% endif %}
                            {% if item.block.type == 'rank_announcement' %}
                              {% set applies = item.block.get('applies_to', {}) %}
                              <div class="small text-muted">Kategorien: {{ (applies.get('size_categories') or ['alle'])|join(', ') }}</div>
                              <div class="small text-muted">Klassen: {{ (applies.get('classes') or ['alle'])|join(', ') }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.block.judge_id %}
                                {{ judges_map.get(item.block.judge_id, 'N/A') }}
                            {% endif %}
                        </td>
                        <td>{{ item.num_starters if item.num_starters > 0 else '' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5">Für diesen Ring sind keine Blöcke geplant.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </main>
</body>
</html>
