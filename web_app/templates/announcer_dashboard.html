{% extends "layout.html" %}
{% block title %}Sprecher Dashboard: {{ event.Bezeichnung }}{% endblock %}

{% block content %}
{% set ring_numbers = ring_numbers or [] %}
<div class="container-fluid announcer-container py-4">
    <div class="mb-4 text-center">
        <h2 class="fw-bold mb-1">Sprecherdisplay</h2>
        <div class="text-muted">{{ event.Bezeichnung }}{% if event.Datum %} · {{ event.Datum }}{% endif %}</div>
    </div>

    <div id="dashboard-container" class="row g-3">
        <div class="col-12 text-center p-5">
            <h2><i class="fas fa-spinner fa-spin me-2"></i>Lade Live-Daten...</h2>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dashboardContainer = document.getElementById('dashboard-container');
    const eventId = '{{ event.id }}';
    const socket = io();
    const ringNumbers = {{ ring_numbers | list | tojson }};

    function ringColClass(count) {
        if (count <= 1) return 'col-12';
        if (count === 2) return 'col-12 col-md-6';
        return 'col-12 col-md-4';
    }

    function fetchAndRenderRing(ringName) {
        fetch(`{{ url_for('live_bp.render_speaker_panel_content', event_id=event.id, ring_name='__RING_NAME__') }}`.replace('__RING_NAME__', ringName))
            .then(response => response.text())
            .then(html => {
                const colId = `ring-col-${ringName.replace(' ', '-')}`;
                let col = document.getElementById(colId);
                if (!col) {
                    col = document.createElement('div');
                    col.className = `${ringColClass(ringNumbers.length)} mb-2`;
                    col.id = colId;
                    dashboardContainer.appendChild(col);
                }
                col.innerHTML = html;
            });
    }
    
    function initialLoad() {
        dashboardContainer.innerHTML = '';

        if (!ringNumbers.length) {
            dashboardContainer.innerHTML = '<div class="col-12 alert alert-warning">Keine Ringe für dieses Event konfiguriert.</div>';
            return;
        }

        ringNumbers.forEach(num => {
            const ringName = `Ring ${num}`;
            const col = document.createElement('div');
            col.className = `${ringColClass(ringNumbers.length)} mb-2`;
            col.id = `ring-col-${ringName.replace(' ', '-')}`;
            dashboardContainer.appendChild(col);
            fetchAndRenderRing(ringName);
        });
    }

    socket.on('connect', function() {
        socket.emit('join_room', {room: `event:${eventId}`});
        console.log('Socket.IO connected!');
    });

    socket.on('announcer_update', function(data) {
        if (data.event_id === eventId) {
            console.log('Update received for ring:', data.ring_name);
            fetchAndRenderRing(data.ring_name);
        }
    });
    socket.on('current_run_changed', function(data) {
        if (data.event_id === eventId && data.ring_id) {
            fetchAndRenderRing(`Ring ${data.ring_id}`);
        }
    });
    socket.on('ring_result_saved', function(data) {
        if (data.event_id === eventId && data.ring_no) {
            fetchAndRenderRing(`Ring ${data.ring_no}`);
        }
    });
    socket.on('ring_starter_changed', function(data) {
        if (data.event_id === eventId && data.ring_no) {
            fetchAndRenderRing(`Ring ${data.ring_no}`);
        }
    });
    socket.on('ring_run_changed', function(data) {
        if (data.event_id === eventId && data.ring_no) {
            fetchAndRenderRing(`Ring ${data.ring_no}`);
        }
    });

    initialLoad();
});
</script>
{% endblock %}
