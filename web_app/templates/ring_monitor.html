{% extends "layout.html" %}
{% block title %}Ring Monitor: {{ ring_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">Ring Monitor – {{ ring_name }}</h4>
        </div>
        <div class="card-body" id="monitor-container">
            <!-- Content is loaded via JavaScript -->
            <div class="text-center p-5">
                <h2><i class="fas fa-spinner fa-spin me-2"></i>Lade Live-Daten für {{ ring_name }}...</h2>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('monitor-container');
    const ringNumber = {{ ring_name.split(' ')[1] }};
    const eventId = '{{ event.id }}';
    const socket = io();

    function fetchAndRender() {
        // KORRIGIERT: API-Endpunkt auf live_bp angepasst
        fetch(`{{ url_for('live_bp.render_ring_monitor_content', ring_number=999) }}`.replace('999', ringNumber))
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
            });
    }

    socket.on('connect', function() {
        socket.emit('join_room', {room: `event:${eventId}:ring:${ringNumber}`});
        console.log('Ring Monitor Socket.IO connected!');
    });

    socket.on('announcer_update', function(data) {
        if (data.event_id === eventId && data.ring_name === '{{ ring_name }}') {
            console.log('Update received for this ring');
            fetchAndRender();
        }
    });
    socket.on('current_run_changed', function(data) {
        if (data.event_id === eventId && String(data.ring_id) === String(ringNumber)) {
            fetchAndRender();
        }
    });

    fetchAndRender(); // Initial load
    setInterval(fetchAndRender, 15000); // Refresh every 15 seconds as a fallback
});
</script>
{% endblock %}
