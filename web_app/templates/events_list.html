{% extends "layout.html" %}
{% block title %}Veranstaltungen{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Veranstaltungen</h1>
    <div>
        <a href="{{ url_for('events_bp.import_event_package') }}" class="btn btn-outline-dark"><i class="fas fa-upload me-2"></i>Event-Paket importieren</a>
        <a href="{{ url_for('events_bp.create_event') }}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Neue Veranstaltung erstellen</a>
    </div>
</div>

<hr>
<h3>Debug / Test</h3>
<p class="text-muted" style="max-width: 900px;">
    Startlisten-JSON hochladen und daraus ein neues Test-Event erstellen.
</p>
<form method="post"
      action="{{ url_for('events_bp.debug_import_create_event') }}"
      enctype="multipart/form-data"
      style="border: 1px solid #ddd; padding: 12px; border-radius: 8px; max-width: 900px;">
    <div class="mb-2">
        <label class="form-label"><b>startlist_all_combined.json</b></label>
        <input type="file" name="startlist_file" accept=".json" required class="form-control">
    </div>
    <div class="mb-2">
        <label class="form-label">Event-Name (optional)</label>
        <input type="text" name="event_name" class="form-control" placeholder="TEST-Import 2025-01-01 10:00">
    </div>
    <div class="form-check mb-1">
        <input class="form-check-input" type="checkbox" name="create_participants" value="1" checked id="debug-create-participants">
        <label class="form-check-label" for="debug-create-participants">Teilnehmer anlegen (dogs + handlers)</label>
    </div>
    <div class="form-check mb-1">
        <input class="form-check-input" type="checkbox" name="create_runs" value="1" checked id="debug-create-runs">
        <label class="form-check-label" for="debug-create-runs">Läufe anlegen (Agility/Jumping pro Klasse/Kategorie)</label>
    </div>
    <div class="form-check mb-1">
        <input class="form-check-input" type="checkbox" name="add_entries" value="1" checked id="debug-add-entries">
        <label class="form-check-label" for="debug-add-entries">Entries hinzufügen</label>
    </div>
    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="sort_entries" value="1" id="debug-sort-entries">
        <label class="form-check-label" for="debug-sort-entries">Entries nach offizieller Startnummer sortieren</label>
    </div>
    <button type="submit" class="btn btn-warning">
        Startlisten-JSON → Test-Event erstellen
    </button>
</form>

<ul class="list-group">
    {% for event in events|sort(attribute='Datum', reverse=True) %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <a href="{{ url_for('events_bp.manage_runs', event_id=event.id) }}" class="text-decoration-none">
                <h5 class="mb-1 {% if event.id == active_event_id %}text-danger fw-bold{% endif %}">
                    {{ event.Bezeichnung }}
                    {% if event.id == active_event_id %}<span class="badge bg-danger ms-2">LIVE</span>{% endif %}
                </h5>
            </a>
            <small class="text-muted">{{ event.Datum | format_date }}</small>
        </div>
        <div>
            {% if event.id != active_event_id %}
            <a href="{{ url_for('events_bp.set_active_event', event_id=event.id) }}" class="btn btn-sm btn-outline-danger" title="Als Live-Event markieren"><i class="fas fa-play-circle"></i></a>
            {% else %}
            <a href="{{ url_for('events_bp.clear_active_event') }}" class="btn btn-sm btn-danger" title="Live-Markierung aufheben"><i class="fas fa-stop-circle"></i></a>
            {% endif %}
            <a href="{{ url_for('events_bp.edit_event', event_id=event.id) }}" class="btn btn-sm btn-secondary" title="Bearbeiten"><i class="fas fa-edit"></i></a>
            <form action="{{ url_for('events_bp.delete_event', event_id=event.id) }}" method="post" class="d-inline" onsubmit="return confirm('Soll die Veranstaltung {{ event.Bezeichnung }} wirklich gelöscht werden?');">
                <button type="submit" class="btn btn-sm btn-outline-dark" title="Löschen"><i class="fas fa-trash"></i></button>
            </form>
        </div>
    </li>
    {% else %}
    <li class="list-group-item">Keine Veranstaltungen gefunden.</li>
    {% endfor %}
</ul>
{% endblock %}
