{% extends "layout.html" %}
{% block title %}Resultaterfassung: {{ run.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">Resultaterfassung: {{ run.name }}</h1>
        <p class="text-muted fs-5">{{ event.Bezeichnung }}</p>
    </div>
    <div>
        <a href="{{ url_for('live_bp.live_event_dashboard') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Zurück zum Dashboard</a>
    </div>
</div>

<div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>Laufdaten: Länge {{ run.laufdaten.parcours_laenge or 'N/A' }}m | SCT {{ sct_display }}s | MCT {{ mct_display }}s</span>
    <a href="{{ url_for('live_bp.set_active_announcer_run', event_id=event.id, run_id=run.id) }}" class="btn btn-warning btn-sm"><i class="fas fa-bullhorn me-2"></i>Für Sprecher-Anzeige aktivieren</a>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-bordered mb-0" id="results-table">
                <thead class="table-light">
                    <tr><th>#</th><th>Hund</th><th>Hundeführer</th><th>Zeit</th><th>Fehler</th><th>Verw.</th><th>DIS</th><th class="text-end">Aktionen</th></tr>
                </thead>
                <tbody>
                    <tr><td colspan="8" class="text-center p-4">Lade Teilnehmer...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <a href="{{ url_for('live_bp.show_ranking', event_id=event.id, run_id=run.id) }}" class="btn btn-success"><i class="fas fa-trophy me-2"></i>Vollständige Rangliste anzeigen</a>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Resultat für #<span id="modalStartNr"></span> <span id="modalDogName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resultForm" onsubmit="return false;">
                    <input type="hidden" id="modalLicenseNumber" name="license_number">
                    <div class="row g-3">
                        <div class="col-md-6"><label for="zeit" class="form-label">Zeit (s)</label><input type="number" step="0.01" class="form-control" id="zeit"></div>
                        <div class="col-md-6"><label for="fehler" class="form-label">Fehler</label><input type="number" step="1" min="0" class="form-control" id="fehler" value="0"></div>
                        <div class="col-md-6"><label for="verweigerungen" class="form-label">Verweigerungen</label><input type="number" step="1" min="0" max="3" class="form-control" id="verweigerungen" value="0"></div>
                        <div class="col-md-6"><label for="disqualifikation" class="form-label">Disqualifikation</label><select class="form-select" id="disqualifikation"><option value="">Nein</option><option value="DIS">DIS</option><option value="ABR">ABR</option></select></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="saveResultBtn">Speichern</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let allEntries = JSON.parse('{{ all_entries_json|safe }}');
        const tableBody = document.querySelector("#results-table tbody");
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        const form = document.getElementById('resultForm');
        let currentLicenseNumber = null;
        const eventId = '{{ event.id }}';
        const runId = '{{ run.id }}';

        function renderTable() {
            if (!tableBody) return;
            let html = '';
            allEntries.sort((a, b) => (a.Startnummer || 9999) - (b.Startnummer || 9999));
            if (allEntries.length === 0) {
                html = '<tr><td colspan="8" class="text-center p-4">Keine Teilnehmer in diesem Lauf.</td></tr>';
            } else {
                allEntries.forEach(entry => {
                    const res = entry.result || {};
                    html += `
                        <tr class="${entry.result ? 'table-success' : ''}">
                            <td>${entry.Startnummer || '-'}</td>
                            <td>${entry.Hundename}</td>
                            <td>${entry.Hundefuehrer}</td>
                            <td>${res.zeit || '-'}</td>
                            <td>${res.fehler != null ? res.fehler : '-'}</td>
                            <td>${res.verweigerungen != null ? res.verweigerungen : '-'}</td>
                            <td>${res.disqualifikation || '-'}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-primary" onclick="window.openModal('${entry.Lizenznummer}')">Resultat</button>
                            </td>
                        </tr>`;
                });
            }
            tableBody.innerHTML = html;
        }

        window.openModal = function(licenseNumber) {
            currentLicenseNumber = licenseNumber;
            const entry = allEntries.find(e => e.Lizenznummer === licenseNumber);
            document.getElementById('modalStartNr').textContent = entry.Startnummer;
            document.getElementById('modalDogName').textContent = entry.Hundename;
            document.getElementById('modalLicenseNumber').value = licenseNumber;

            form.reset();
            form.elements['fehler'].value = 0;
            form.elements['verweigerungen'].value = 0;

            if (entry.result) {
                form.elements['zeit'].value = entry.result.zeit || '';
                form.elements['fehler'].value = entry.result.fehler != null ? entry.result.fehler : 0;
                form.elements['verweigerungen'].value = entry.result.verweigerungen != null ? entry.result.verweigerungen : 0;
                form.elements['disqualifikation'].value = entry.result.disqualifikation || '';
            }
            resultModal.show();
        };

        document.getElementById('saveResultBtn').addEventListener('click', function() {
            const data = {
                license_number: currentLicenseNumber,
                zeit: form.elements['zeit'].value,
                fehler: form.elements['fehler'].value,
                verweigerungen: form.elements['verweigerungen'].value,
                disqualifikation: form.elements['disqualifikation'].value
            };

            fetch(`{{ url_for('live_bp.save_result', event_id=eventId, run_id=runId) }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if(result.success) {
                    const entry = allEntries.find(e => e.Lizenznummer === currentLicenseNumber);
                    entry.result = data;
                    renderTable();
                    resultModal.hide();
                } else {
                    alert('Fehler beim Speichern: ' + result.message);
                }
            });
        });
        
        renderTable();
    });
</script>
{% endblock %}