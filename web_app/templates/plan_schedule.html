{% extends "layout.html" %}
{% block title %}Zeitplan – {{ event.Bezeichnung }}{% endblock %}

{% block content %}
  <div class="container-fluid py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">Zeitplan – {{ event.Bezeichnung }}</h3>
      <div>
        <a class="btn btn-outline-secondary me-2" href="{{ url_for('events_bp.events_list') }}">Zurück</a>
        <div class="btn-group me-2" role="group">
          <a class="btn btn-outline-primary" href="{{ url_for('print_bp.print_schedule', event_id=event.id) }}" target="_blank">Vorbereitungsdrucksachen</a>
          <button class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Weitere Drucke</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('print_bp.print_startlists', event_id=event.id) }}" target="_blank">Startlisten</a></li>
            <li><a class="dropdown-item" href="{{ url_for('print_bp.print_stewardlists', event_id=event.id) }}" target="_blank">Ringschreiberlisten</a></li>
            <li><a class="dropdown-item" href="{{ url_for('print_bp.print_master_steward_list', event_id=event.id) }}" target="_blank">Einweiserlisten</a></li>
          </ul>
        </div>
        <button class="btn btn-primary" form="form-save-schedule">Zeitplan speichern</button>
      </div>
    </div>

  <!-- Konfiguration Kopf -->
  <div class="card mb-3">
    <div class="card-body">
      <form id="form-save-schedule" method="post" action="{{ url_for('events_bp.save_schedule', event_id=event.id) }}">
        <div class="row g-3 align-items-end">
          {% for i in range(1, (num_rings or 1)+1) %}
          {% set ring_key = 'ring_' ~ i %}
          <div class="col-12 col-md-3">
            <label class="form-label">Startzeit Ring {{ i }}</label>
            <input
              type="time"
              class="form-control"
              name="start_time_ring_{{ i }}"
              value="{{ (event.start_times_by_ring or {}).get(ring_key, (schedule.rings or {}).get(i|string, {}).get('start_time', '07:30')) }}"
              required>
          </div>
          {% endfor %}
          <!-- Hidden: hier landet der JSON-Plan -->
          <input type="hidden" name="schedule_json" id="schedule_json">
        </div>
      </form>
    </div>
  </div>

  <!-- Block hinzufügen -->
  <div class="card mb-3">
    <div class="card-header">Block hinzufügen</div>
    <div class="card-body">
      <form method="post" action="{{ url_for('events_bp.add_schedule_block', event_id=event.id) }}">
        <div class="row g-3">
          <div class="col-12 col-md-2">
            <label class="form-label">Block-Typ</label>
            <select name="block_type" class="form-select">
              <option value="run" selected>Lauf</option>
              <option value="rank_announcement">Rangverkündigung</option>
            </select>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Ring</label>
            <select name="ring" class="form-select">
              {% for i in range(1, (num_rings or 1)+1) %}
                <option value="{{ i }}">Ring {{ i }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Titel (optional)</label>
            <input name="title" type="text" class="form-control" placeholder="Bezeichnung">
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Format (run)</label>
            <select name="run_format" class="form-select">
              <option value="normal">Normal</option>
              <option value="open">Open</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Zeit-Laufart (run)</label>
            <select name="timing_run_type" class="form-select">
              <option value="agility">Agility</option>
              <option value="jumping">Jumping</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Kategorie (run)</label>
            <select name="size_category" class="form-select">
              <option value="all">Alle</option>
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="intermediate">Intermediate</option>
              <option value="large">Large</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Klassen (run)</label>
            <div class="d-flex gap-2 align-items-center flex-wrap">
              {% for kl in ['1','2','3'] %}
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="class_{{ kl }}" name="classes" value="{{ kl }}" checked>
                  <label class="form-check-label" for="class_{{ kl }}">{{ kl }}</label>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Sortierung (run)</label>
            <div class="d-flex flex-column gap-1">
              <div class="d-flex gap-1 align-items-center">
                <span class="small text-muted">Primär</span>
                <select name="sort_primary_field" class="form-select form-select-sm w-auto">
                  <option value="none">Keine</option>
                  <option value="category">Kategorie</option>
                  <option value="class">Klasse</option>
                </select>
                <select name="sort_primary_dir" class="form-select form-select-sm w-auto">
                  <option value="asc">asc</option>
                  <option value="desc">desc</option>
                </select>
              </div>
              <div class="d-flex gap-1 align-items-center">
                <span class="small text-muted">Sekundär</span>
                <select name="sort_secondary_field" class="form-select form-select-sm w-auto">
                  <option value="none">Keine</option>
                  <option value="category">Kategorie</option>
                  <option value="class">Klasse</option>
                </select>
                <select name="sort_secondary_dir" class="form-select form-select-sm w-auto">
                  <option value="asc">asc</option>
                  <option value="desc">desc</option>
                </select>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Richter (run)</label>
            <select name="judge_id" class="form-select">
              <option value="">— keiner —</option>
              {% for j in judges|sort(attribute="firstname") %}
                <option value="{{ j.id }}">{{ (j.firstname ~ ' ' ~ j.lastname).strip() }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Dauer (Sekunden, Rangverk.)</label>
            <input name="rank_duration" type="number" class="form-control" value="{{ rank_announcement_default or 300 }}" min="0">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Gilt für Kategorien (Rangverk.)</label>
            <div class="d-flex flex-wrap gap-2">
              {% for cat in ['small','medium','intermediate','large'] %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rank_cat_{{ cat }}" name="rank_categories" value="{{ cat }}" checked>
                  <label class="form-check-label" for="rank_cat_{{ cat }}">{{ cat.capitalize() }}</label>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Gilt für Klassen (Rangverk.)</label>
            <div class="d-flex flex-wrap gap-2">
              {% for kl in ['1','2','3'] %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rank_class_{{ kl }}" name="rank_classes" value="{{ kl }}" checked>
                  <label class="form-check-label" for="rank_class_{{ kl }}">{{ kl }}</label>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Notizen</label>
            <input name="notes" type="text" class="form-control" placeholder="Optional">
          </div>

          <div class="col-12">
            <button class="btn btn-success" type="submit">Block hinzufügen</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Zeitplan je Ring -->
  <div class="row" id="schedule-rows">
    {% for i in range(1, (num_rings or 1)+1) %}
    {% set ring_key = i|string %}
    {% set ring_data = (schedule.rings or {}).get(ring_key, {}) %}
    <div class="col-12 col-xl-6">
      <div class="card mb-3" data-ring="ring_{{ i }}">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Ring {{ i }}</strong>
          <small class="text-muted">Start: {{ (event.start_times_by_ring or {}).get('ring_' ~ i, '07:30') }}</small>
        </div>
        <div class="card-body d-flex flex-column gap-2">
          {% for block in ring_data.blocks or [] %}
            <div class="card shadow-sm" style="border-left: 4px solid {{ '#0d6efd' if block.type == 'run' else '#6c757d' }};">
              <div class="card-body py-2 px-3 d-flex flex-wrap align-items-center justify-content-between">
                <div class="fw-semibold">{{ block.title or block.type }}</div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-light text-dark ms-2">
                    R: {{ (judge_name_map or {}).get(block.judge_id, '—') }}
                  </span>
                  <form method="post" action="{{ url_for('events_bp.move_schedule_block', event_id=event.id) }}" class="m-0">
                    <input type="hidden" name="ring" value="{{ ring_key }}">
                    <input type="hidden" name="block_id" value="{{ block.id }}">
                    <button class="btn btn-sm btn-outline-secondary" name="direction" value="up" title="Nach oben">↑</button>
                    <button class="btn btn-sm btn-outline-secondary" name="direction" value="down" title="Nach unten">↓</button>
                  </form>
                  <form method="post" action="{{ url_for('events_bp.delete_schedule_block', event_id=event.id) }}" class="m-0">
                    <input type="hidden" name="ring" value="{{ ring_key }}">
                    <input type="hidden" name="block_id" value="{{ block.id }}">
                    <button class="btn btn-sm btn-outline-danger">Entfernen</button>
                  </form>
                </div>
              </div>
              <div class="card-body py-2 px-3">
                {% if block.type == 'run' %}
                  <div class="small text-muted">Format: {{ block.run_format or 'normal' }} | Laufart: {{ block.timing_run_type }}</div>
                  <div class="small text-muted">Kategorie: {{ block.size_category }} | Klassen: {{ (block.classes or [])|join(', ') }}</div>
                  {% set primary = (block.sort or {}).get('primary', {}) %}
                  {% set secondary = (block.sort or {}).get('secondary', {}) %}
                  <div class="small text-muted">Sortierung: {{ primary.get('field', 'none') }} ({{ primary.get('direction', 'asc') }}) / {{ secondary.get('field', 'none') }} ({{ secondary.get('direction', 'asc') }})</div>
                  {% if block.estimated %}
                    <div class="small text-muted">Teilnehmer: {{ block.estimated.participants_total or 0 }}, Dauer ca.: {{ (block.estimated.total_seconds or 0) / 60 }} min</div>
                  {% endif %}
                {% else %}
                  <div class="small text-muted">Dauer: {{ block.duration_seconds or (rank_announcement_default or 300) }} Sekunden</div>
                  {% set applies_to = block.applies_to or {} %}
                  <div class="small text-muted">Gilt für Kategorien: {{ (applies_to.size_categories or ['alle'])|join(', ') }}</div>
                  <div class="small text-muted">Gilt für Klassen: {{ (applies_to.classes or ['alle'])|join(', ') }}</div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="text-muted">Noch keine Blöcke geplant.</div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if timelines_by_ring %}
  <div class="card mb-3">
    <div class="card-header">Zeitplan-Vorschau (berechnete Timeline)</div>
    <div class="card-body">
      <div class="row g-3">
        {% for ring, timeline in timelines_by_ring.items()|sort %}
        <div class="col-12 col-xl-6">
          <h6 class="mb-2">Ring {{ ring }} – Start {{ (event.start_times_by_ring or {}).get('ring_' ~ ring, '07:30') }}</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 15%;">Start</th>
                  <th style="width: 15%;">Ende</th>
                  <th>Segment</th>
                  <th style="width: 20%;">Block</th>
                  <th style="width: 10%;">Starter</th>
                </tr>
              </thead>
              <tbody>
                {% for item in timeline %}
                  <tr>
                    <td>{{ item.start_time }}</td>
                    <td>{{ item.end_time }}</td>
                    <td>{{ item.label }}</td>
                    <td>{{ item.block.title or item.block.type }}</td>
                    <td>{% if item.num_starters %}{{ item.num_starters }}{% endif %}</td>
                  </tr>
                {% else %}
                  <tr><td colspan="5" class="text-muted">Keine Segmente vorhanden.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Startnummern-Schema und Vergabe (wiederhergestellt) -->
  <div class="row mb-3">
    <div class="col-12 col-xl-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Startnummern-Schema</span>
          <form class="m-0" method="post" action="{{ url_for('events_bp.load_schema_template', event_id=event.id) }}">
            <button class="btn btn-sm btn-outline-secondary" type="submit">Vorlage laden</button>
          </form>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('events_bp.save_schema', event_id=event.id) }}">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-3">
                <thead class="table-light">
                  <tr>
                    <th>Kategorie</th>
                    <th>Klasse</th>
                    <th>Startnummer ab</th>
                  </tr>
                </thead>
                <tbody>
                {% set schema = event.start_number_schema or {} %}
                {% for cat in possible_categories %}
                  {% for cls in possible_classes %}
                  <tr>
                    <td>{{ cat }}</td>
                    <td>{{ cls }}</td>
                    <td>
                      <input type="number"
                             class="form-control form-control-sm"
                             name="{{ cat }}-{{ cls }}"
                             value="{{ schema.get(cat ~ '-' ~ cls, '') }}"
                             min="1">
                    </td>
                  </tr>
                  {% endfor %}
                {% endfor %}
                  <tr>
                    <td colspan="2">Fallback</td>
                    <td>
                      <input type="number"
                             class="form-control form-control-sm"
                             name="Default"
                             value="{{ schema.get('Default', '') }}"
                             min="1">
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn btn-primary" type="submit">Schema speichern</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card h-100">
        <div class="card-header">Startnummern vergeben</div>
        <div class="card-body">
          <form class="row g-3 align-items-end" method="post" action="{{ url_for('events_bp.generate_startlist', event_id=event.id) }}">
            <div class="col-12 col-md-6">
              <label class="form-label">Abstand zwischen Hundeführern</label>
              <input type="number" class="form-control" name="handler_distance" value="20" min="1">
            </div>
            <div class="col-12 col-md-6 d-flex gap-2">
              <button class="btn btn-outline-secondary flex-fill" type="submit">Startnummern generieren</button>
            </div>
          </form>
          <p class="small text-muted mt-3 mb-0">Die automatische Vergabe nutzt die oben definierten Startnummern-Blöcke und mischt die Starter zufällig.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Vorschau Startnummern -->
  <div class="card mb-5">
    <div class="card-header">Vorschau – vergebene Startnummern</div>
    <div class="card-body table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 80px;">Startnr.</th>
            <th>Lizenz</th>
            <th>Hundeführer</th>
            <th>Hund</th>
            <th>Kat/Kl</th>
          </tr>
        </thead>
        <tbody>
        {% for p in preview_list %}
          <tr>
            <td>{{ p.Startnummer }}</td>
            <td>{{ p.Lizenznummer }}</td>
            <td>{{ p.Hundefuehrer }}</td>
            <td>{{ p.Hundename }}</td>
            <td>{{ p.Kategorie }} {{ p.Klasse }}</td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-muted">Noch keine Startnummern vergeben.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
